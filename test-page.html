<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoPurge æ‰©å±•æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .error {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }
        .success {
            border-left-color: #27ae60;
            background: #f0f9f0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.enabled { background: #27ae60; color: white; }
        .status.disabled { background: #e74c3c; color: white; }
        .status.unknown { background: #95a5a6; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ”§ AutoPurge æ‰©å±•æµ‹è¯•é¡µé¢</h1>
    
    <div class="section">
        <h2>ğŸ“Š æ‰©å±•çŠ¶æ€æ£€æŸ¥</h2>
        <p>æ‰©å±•çŠ¶æ€: <span id="extensionStatus" class="status unknown">æ£€æŸ¥ä¸­...</span></p>
        <p>å½“å‰ç½‘ç«™: <span id="currentSite">æ£€æŸ¥ä¸­...</span></p>
        <p>åŸŸååŒ¹é…: <span id="domainMatch">æ£€æŸ¥ä¸­...</span></p>
        <button onclick="checkExtensionStatus()">åˆ·æ–°çŠ¶æ€</button>
    </div>
    
    <div class="section">
        <h2>ğŸŒ åŸŸååŒ¹é…æµ‹è¯•</h2>
        <p>æµ‹è¯• 91porny.com æ˜¯å¦ä¼šè¢«æ£€æµ‹åˆ°ï¼š</p>
        <button onclick="testDomainMatching()">æµ‹è¯•åŸŸååŒ¹é…</button>
        <div id="domainTestResult"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ“œ å†å²è®°å½•æ£€æŸ¥</h2>
        <p>æ£€æŸ¥æµè§ˆå™¨å†å²è®°å½•ä¸­æ˜¯å¦æœ‰ 91porny.comï¼š</p>
        <button onclick="checkBrowserHistory()">æ£€æŸ¥å†å²è®°å½•</button>
        <div id="historyResult"></div>
    </div>
    
    <div class="section">
        <h2>âš™ï¸ æ‰©å±•é…ç½®</h2>
        <p>æ£€æŸ¥æ‰©å±•çš„é…ç½®è®¾ç½®ï¼š</p>
        <button onclick="checkExtensionConfig()">æ£€æŸ¥é…ç½®</button>
        <div id="configResult"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ” è°ƒè¯•æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="debugLog" class="log">ç­‰å¾…è°ƒè¯•ä¿¡æ¯...</div>
    </div>
    
    <div class="section">
        <h2>â“ é—®é¢˜è¯Šæ–­</h2>
        <h3>Security å’Œ History Record çš„åŒºåˆ«ï¼š</h3>
        <ul>
            <li><strong>Security</strong>ï¼šæµè§ˆå™¨å®‰å…¨çŠ¶æ€ï¼ŒæŒ‡ç½‘ç«™æ˜¯å¦ä½¿ç”¨ HTTPS åŠ å¯†è¿æ¥</li>
            <li><strong>History Record</strong>ï¼šæ‰©å±•å†…éƒ¨åŠŸèƒ½ï¼Œè®°å½•è¢«åˆ é™¤çš„æµè§ˆå†å²æ¡ç›®</li>
        </ul>
        
        <h3>ä¸ºä»€ä¹ˆ 91porny.com æ²¡æœ‰å‡ºç°åœ¨å†å²è®°å½•ä¸­ï¼š</h3>
        <ol>
            <li>æ‰©å±•å¯èƒ½æœªå¯ç”¨</li>
            <li>åŸŸååŒ¹é…é€»è¾‘å¯èƒ½æœ‰é—®é¢˜</li>
            <li>å†å²è®°å½•åŠŸèƒ½å¯èƒ½æœªå¯ç”¨</li>
            <li>å»¶è¿Ÿåˆ é™¤æœºåˆ¶ï¼ˆ10ç§’å»¶è¿Ÿï¼‰</li>
            <li>æµè§ˆå™¨å†å²è®°å½•ä¸­ç¡®å®æ²¡æœ‰è¯¥ç½‘ç«™</li>
        </ol>
    </div>

    <script>
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLog.push(logEntry);
            
            const logElement = document.getElementById('debugLog');
            logElement.textContent = debugLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function clearLog() {
            debugLog = [];
            document.getElementById('debugLog').textContent = 'æ—¥å¿—å·²æ¸…ç©º';
        }
        
        async function checkExtensionStatus() {
            log('å¼€å§‹æ£€æŸ¥æ‰©å±•çŠ¶æ€...');
            
            try {
                // æ£€æŸ¥æ‰©å±•æ˜¯å¦å“åº”
                const response = await chrome.runtime.sendMessage({ action: 'getConfig' });
                log('æ‰©å±•é…ç½®åŠ è½½æˆåŠŸ', 'success');
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                const statusElement = document.getElementById('extensionStatus');
                if (response.enabled) {
                    statusElement.textContent = 'å·²å¯ç”¨';
                    statusElement.className = 'status enabled';
                } else {
                    statusElement.textContent = 'å·²ç¦ç”¨';
                    statusElement.className = 'status disabled';
                }
                
                // æ£€æŸ¥å½“å‰æ ‡ç­¾é¡µçŠ¶æ€
                const tabStatus = await chrome.runtime.sendMessage({ action: 'getCurrentTabStatus' });
                log('å½“å‰æ ‡ç­¾é¡µçŠ¶æ€: ' + JSON.stringify(tabStatus));
                
                document.getElementById('currentSite').textContent = tabStatus.hostname || 'æœªçŸ¥';
                document.getElementById('domainMatch').textContent = tabStatus.isMatched ? 'âœ… åŒ¹é…' : 'âŒ ä¸åŒ¹é…';
                
                return response;
                
            } catch (error) {
                log('æ‰©å±•æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
                document.getElementById('extensionStatus').textContent = 'æœªåŠ è½½';
                document.getElementById('extensionStatus').className = 'status disabled';
                return null;
            }
        }
        
        async function testDomainMatching() {
            log('å¼€å§‹æµ‹è¯•åŸŸååŒ¹é…...');
            
            const testUrls = [
                'https://91porny.com',
                'https://www.91porny.com',
                'https://91porny.com/',
                'https://91porny.com/some-page'
            ];
            
            const resultDiv = document.getElementById('domainTestResult');
            let html = '<h4>æµ‹è¯•ç»“æœï¼š</h4>';
            
            for (const url of testUrls) {
                try {
                    const urlObj = new URL(url);
                    const hostname = urlObj.hostname.toLowerCase();
                    
                    // é¢„è®¾åŸŸååˆ—è¡¨ï¼ˆä»æ‰©å±•ä»£ç ä¸­å¤åˆ¶ï¼‰
                    const presetDomains = [
                        "xvideos.com", "pornhub.com", "xnxx.com", "redtube.com", "youporn.com",
                        "tube8.com", "spankbang.com", "xhamster.com", "chaturbate.com", "cam4.com",
                        "stripchat.com", "bongacams.com", "livejasmin.com", "camsoda.com", "myfreecams.com",
                        "onlyfans.com", "fansly.com", "manyvids.com", "clips4sale.com", "iwantclips.com",
                        "91porny.com", "google.com", "facebook.com", "youtube.com", "twitter.com",
                        "instagram.com", "linkedin.com", "reddit.com", "amazon.com", "netflix.com", "spotify.com"
                    ];
                    
                    let matched = false;
                    for (const domain of presetDomains) {
                        if (hostname === domain || hostname.endsWith('.' + domain)) {
                            matched = true;
                            break;
                        }
                    }
                    
                    const status = matched ? 'âœ… åŒ¹é…' : 'âŒ ä¸åŒ¹é…';
                    const color = matched ? 'green' : 'red';
                    
                    html += `<p style="color: ${color};">${url} â†’ ${status}</p>`;
                    log(`${url} â†’ ${status}`);
                    
                } catch (error) {
                    html += `<p style="color: red;">${url} â†’ è§£æå¤±è´¥: ${error.message}</p>`;
                    log(`${url} â†’ è§£æå¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            resultDiv.innerHTML = html;
        }
        
        async function checkBrowserHistory() {
            log('å¼€å§‹æ£€æŸ¥æµè§ˆå™¨å†å²è®°å½•...');
            
            try {
                const history = await chrome.history.search({
                    text: '91porny',
                    maxResults: 10,
                    startTime: Date.now() - (24 * 60 * 60 * 1000) // æœ€è¿‘24å°æ—¶
                });
                
                const resultDiv = document.getElementById('historyResult');
                
                if (history.length === 0) {
                    resultDiv.innerHTML = '<p style="color: orange;">âŒ æ²¡æœ‰æ‰¾åˆ°åŒ…å« 91porny çš„å†å²è®°å½•</p>';
                    log('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†å²è®°å½•', 'warning');
                } else {
                    let html = `<h4>æ‰¾åˆ° ${history.length} æ¡ç›¸å…³å†å²è®°å½•ï¼š</h4>`;
                    history.forEach((item, index) => {
                        const visitTime = new Date(item.lastVisitTime).toLocaleString();
                        html += `<p>${index + 1}. <a href="${item.url}" target="_blank">${item.title || item.url}</a><br>
                                <small>è®¿é—®æ—¶é—´: ${visitTime}</small></p>`;
                    });
                    resultDiv.innerHTML = html;
                    log(`æ‰¾åˆ° ${history.length} æ¡ç›¸å…³å†å²è®°å½•`, 'success');
                }
                
                return history;
                
            } catch (error) {
                log('æ£€æŸ¥å†å²è®°å½•å¤±è´¥: ' + error.message, 'error');
                document.getElementById('historyResult').innerHTML = '<p style="color: red;">âŒ æ£€æŸ¥å¤±è´¥: ' + error.message + '</p>';
                return [];
            }
        }
        
        async function checkExtensionConfig() {
            log('å¼€å§‹æ£€æŸ¥æ‰©å±•é…ç½®...');
            
            try {
                const config = await chrome.runtime.sendMessage({ action: 'getConfig' });
                const stats = await chrome.runtime.sendMessage({ action: 'getStats' });
                const historySettings = await chrome.storage.local.get(['historySettings']);
                const historyRecords = await chrome.storage.local.get(['historyRecords']);
                
                const resultDiv = document.getElementById('configResult');
                
                let html = '<h4>æ‰©å±•é…ç½®ï¼š</h4>';
                html += `<p><strong>å¯ç”¨çŠ¶æ€:</strong> ${config.enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨'}</p>`;
                html += `<p><strong>å»¶è¿Ÿæ—¶é—´:</strong> ${config.delaySec} ç§’</p>`;
                html += `<p><strong>ç”¨æˆ·åŸŸåæ•°é‡:</strong> ${config.userDomains ? config.userDomains.length : 0}</p>`;
                html += `<p><strong>ä»Šæ—¥åˆ é™¤æ¬¡æ•°:</strong> ${stats.deletionsToday || 0}</p>`;
                html += `<p><strong>æ€»åˆ é™¤æ¬¡æ•°:</strong> ${stats.deletionsTotal || 0}</p>`;
                html += `<p><strong>é˜Ÿåˆ—å¤§å°:</strong> ${stats.queueSize || 0}</p>`;
                
                if (historySettings.historySettings) {
                    const settings = historySettings.historySettings;
                    html += '<h4>å†å²è®°å½•è®¾ç½®ï¼š</h4>';
                    html += `<p><strong>è‡ªåŠ¨è®°å½•:</strong> ${settings.autoRecord ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}</p>`;
                    html += `<p><strong>æœ€å¤§è®°å½•æ•°:</strong> ${settings.maxRecords || 1000}</p>`;
                    html += `<p><strong>ä¿ç•™å¤©æ•°:</strong> ${settings.retentionDays || 30}</p>`;
                }
                
                if (historyRecords.historyRecords) {
                    const records = historyRecords.historyRecords;
                    html += '<h4>å†å²è®°å½•ï¼š</h4>';
                    html += `<p><strong>è®°å½•æ•°é‡:</strong> ${records.length}</p>`;
                    
                    if (records.length > 0) {
                        html += '<h5>æœ€è¿‘çš„è®°å½•ï¼š</h5>';
                        records.slice(0, 5).forEach((record, index) => {
                            const deletedTime = new Date(record.deletedAt).toLocaleString();
                            html += `<p>${index + 1}. ${record.url}<br><small>åˆ é™¤æ—¶é—´: ${deletedTime}</small></p>`;
                        });
                    }
                }
                
                resultDiv.innerHTML = html;
                log('é…ç½®æ£€æŸ¥å®Œæˆ', 'success');
                
            } catch (error) {
                log('é…ç½®æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
                document.getElementById('configResult').innerHTML = '<p style="color: red;">âŒ é…ç½®æ£€æŸ¥å¤±è´¥: ' + error.message + '</p>';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æ£€æŸ¥...');
            checkExtensionStatus();
        });
    </script>
</body>
</html>
